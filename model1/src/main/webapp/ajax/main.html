<!--
	Ajax(Asynchronous Javascript And XML)
	- 비동기적 자바스크립트와 xml
	- 자바스크립트를 이용한 비동기적 통신과 그에 사용되는 데이터인  xml
	- 하지만 현재는 xml보다는 json이 훨씬 많이 사용됨...
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .container{
            width: 650px;
            height: 500px;
            background-color: aliceblue;
            margin: auto;
        }
        .aside{
            width: 150px;
            height: 100%;
            background-color: antiquewhite;
            float: left;
        }
        .aside input{
            width: 90%;
        }
        .aside button{
            width: 40%;
        }
        .content{
            width: 500px;
            height: 100%;
            background-color: aqua;
            float: left;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
    	/*
    		목록을 출력하는 작업은 꼭 등록할 때만이 아니라, 유저가 처음 브라우저로 main.html 요청한 시점부터도 목록이 나와야 하므로,
    		목록 기능은 재사용 가능성이 높다.. 따라서 함수로 별도로 정의
    	*/
    	function render(list){
    		console.log("전달받은 배열은 ", list);
    		
    		 // 렌더링 작업은 상당히 고달픈 작업이면서, 시간이 많이 걸림... 따라서 이와 관련되어 나온 기술이 Vue, React.js...
    		 //document.querySelector(".content").innerHTML = "<table>";
    		 let tag = "<table width = '100%' border='1px'>";
    		 tag+="<thead>";
    		 tag+="<tr>";
    		 tag+="<th>ID</th>";
    		 tag+="<th>Name</th>";
    		 tag+="<th>Email</th>";
    		 tag+="</tr>";
    		 tag+="</thead>";
    		 
    		 tag+="<tbody>";
    		 for(let i = 0; i < list.length; i++){
    			 let member = list[i];
	    		 tag+="<tr>";
	    		 tag+="<td>"+member.id+"</td>";
	    		 tag+="<td>"+member.name+"</td>";
	    		 tag+="<td>"+member.email+"</td>";
	    		 tag+="</tr>";
    		 }
    		 tag+="</tbody>";
    		 tag += "</table>";
    		 
    		 $(".content").html(tag);
    	}
    	
    	// 서버에 목록 요청(비동기적)
    	function getList(){
    		// 비동기적 요청을 담당하는 XMLHttpRequest 객체를 사용
    		let xhttp = new XMLHttpRequest();
    		
    		// 서버에 응답으 도달하면 지정한 익명함수가 호출(by javascript)
    		xhttp.onload=function(){
    			// 서버에서 전송한 json 문자열을 파싱하여 화면에 렌더링!!
    			console.log("서버가 응답한 데이터는 ", this.responseText);
    			
    			// 파싱 시 주의점? 반드시 문자열이 JSON표기법을 따른 것만이 파싱이 성공할 수 있다.
    			let memberList = JSON.parse(this.responseText);
    			
    			// 화면에 렌더링
    			render(memberList);
    		}
    		
    		xhttp.open("GET", "/ajax/async_list.jsp");	// 요청 준비
    		xhttp.send();		// 여기서 요청 발생..
    	}
    	
	    function regist(){
	    	// 서버에 요청을 시도하되, 비동기로 요청하자!!
	    	let xhttp = new XMLHttpRequest();	// JS의 비동기 통신 객체
	    	
	    	xhttp.onload = function(){
	    		// 서버에서 응답 정보가 도착하면 호출되는 익명함수 역할로서는 콜백함수(역할)
/* 	    		console.log("서버에서 보내온 데이터는 ", this.responseText);
	    		
	    		// 받아온 데이터는 언제나 문자열이므로, oop식으로 제어하려면 파싱하자!!
	    		let memberList=JSON.parse(this.responseText);
	    		console.log("memberList ", memberList);
	    		
				// 서버에서 가져온 데이터를 화면에 출력
				getList(memberList); */
				console.log("등록완료");
				
				getList();	// 등록완료와 동시에 다시 비동기적 요청 시도
 			}
	    	
	    	xhttp.open("POST", "/ajax/async_regist.jsp");	// 요청 방법 및 요청 주소 지정
	    	xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=utf-8");		// 전송 시 헤더 지정
	    	xhttp.send("id="+$("input[name='id']").val()+"&name="+$("input[name='name']").val()+"&email="+$("input[name='email']").val());	
							// 비동기 요청 출발~(이때 요청 시도 자체를 자바스크립트가 하지 않고 브라우저에게 시킴)
							// 자바스크립트는 응답정보가 올 때까지 대기상태에 빠지지 않고, 자신의 다른 일을 할 수 있다.(비동기),
							// 응답이 올 때까지 기다리지 않았기 때문에, 즉 순서를 지키지 않았기 때문에 비동기 방식
							// 브라우저가 응답을 받아오면, 자바스크립트에게 알림... 이때 자바스크립트의 XMLHttpRequest의 onload 속성에 지정한
							// 익명함수인 콜백함수를 호출하게 된다..(누가? js가)
			
	    }
    	$(()=>{
    		$("button").click(()=>{
    			regist();
    		});
    		
    		// 문서가 로드되면 기존에 누적된 데이터를 비동기적으로 가져오자
    		getList();
    	});
    </script>
</head>
<body>
    <div class="container">
        <div class="aside">
            <form>
                <input type="text" placeholder="Your ID..." name="id">
                <input type="text" placeholder="Your name..." name="name">
                <input type="text" placeholder="Your email..." name="email">
                <button type="button">등록</button>
            </form>
        </div>
        <div class="content"></div>
    </div>
</body>
</html>